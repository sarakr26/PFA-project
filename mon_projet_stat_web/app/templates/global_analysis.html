<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse Globale des Cours</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global_analysis.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/details-section.css') }}">
</head>
<body class="bg-light">
    <header class="main-header">
    <div class="header-logo">
        <img src="{{ url_for('static', filename='img/image_droite.png') }}" alt="Logo" style="height:48px;">
    </div>
    <div class="header-actions">
        <nav class="header-nav">
            <a href="{{ url_for('main.extract') }}">Cours</a>
            <a href="{{ url_for('main.extract') }}#users-graph">Utilisateurs</a>
            <a href="{{ url_for('main.global_analysis') }}">Départements</a>
        </nav>
        <div class="header-logout">
            <a href="{{ url_for('main.logout') }}">Déconnexion</a>
        </div>
    </div>
</header>
    <div class="loading" id="loading" style="display: none;">
        <div class="loading-content">
            <h3>Analyse en cours...</h3>
            <p id="loading-text">Extraction des données...</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100" 
                     style="width: 0%">0%</div>
            </div>
        </div>
    </div>

    <div class="analysis-container">
        <div class="dashboard-container">
            <h2 class="dashboard-title text-center mb-4">Statistiques par Département</h2>
            
            <div class="departments-grid">
                {% for dept in ['IT', 'PCP', 'PGM', 'PHR', 'PLM', 'PPE', 'PPM', 'PPR', 'PQM', 'PTS'] %}
                <div class="department-card card-hover-effect" data-dept="{{ dept }}">
                    <div class="department-icon">{{ dept[:2] }}</div>
                    <div class="department-name">{{ dept }}</div>
                    
                    <div class="department-stats">
                        <div class="stat-item">
                            <small>Utilisateurs totaux</small>
                            <h4>{{ dept_stats[dept].total_users }}</h4>
                        </div>
                        <!-- Taux de complétion moyen supprimé -->
                        <div class="stat-item">
                            <small>Nombre de cours</small>
                            <h4>{{ dept_stats[dept].courses_with_users }}</h4>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% for dept in ['IT', 'PCP', 'PGM', 'PHR', 'PLM', 'PPE', 'PPM', 'PPR', 'PQM', 'PTS'] %}
            <div class="details-section text-center" id="details-{{ dept }}">
                <h3 class="mb-4">Détails pour le département {{ dept }}</h3>
                <div class="row mb-4 justify-content-center">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Utilisateurs</h5>
                                <p class="card-text h2">{{ dept_stats[dept].total_users }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Nombre de Cours</h5>
                                <p class="card-text h2">{{ dept_stats[dept].courses_with_users }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 text-center cours-disponibles-title">Cours disponibles</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for course in dept_stats[dept].courses %}
                            <li class="list-group-item">{{ course.cours }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-center align-middle">
                        <thead class="table-primary text-center">
                            <tr>
                                <th class="text-center align-middle" style="vertical-align: middle;">Cours</th>
                                <th class="text-center align-middle" style="vertical-align: middle;">Utilisateurs</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in dept_stats[dept].courses %}
                            <tr>
                                <td>{{ course.cours }}</td>
                                <td>{{ course.users }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        <h2 class="text-center mb-4">Analyse Globale des Cours</h2>
        <div class="dashboard-container"></div>

        <div class="mb-4 d-flex justify-content-center align-items-center gap-3">
            <button id="start-analysis" class="btn btn-analysis">
                Démarrer l'analyse globale
            </button>
           
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-primary">
                    <tr>
                        <th>Cours</th>
                        {% for dept in departments %}
                        <th>{{ dept }}</th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses_data %}
                    <tr>
                        <td>{{ course.cours }}</td>
                        {% for dept in departments %}
                        <td>{{ course.departments.get(dept, 0) }}</td>
                        {% endfor %}
                        <td>{{ course.total }}</td>
                    </tr>
                    {% endfor %}
                    <!-- Ligne du nombre de cours par département (où users > 0) -->
                    <tr style="font-weight:bold; background:#e3e6f7;">
                        <td>Nombre de cours avec utilisateurs</td>
                        {% for dept in departments %}
                        <td>{{ total_courses_by_dept[dept] }}</td>
                        {% endfor %}
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/global_analysis.js') }}"></script>
</body>
</html>
