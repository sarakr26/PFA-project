<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Extraction des statistiques</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/extract.css') }}">
</head>
<body class="bg-light">
    <header class="main-header">
    <div class="header-logo">
        <img src="{{ url_for('static', filename='img/image_droite.png') }}" alt="Logo" style="height:48px;">
    </div>
    <div class="header-actions">
        <nav class="header-nav">
            <a href="{{ url_for('main.extract') }}">Cours</a>
            <a href="{{ url_for('main.extract') }}#users-graph">Utilisateurs</a>
            <a href="{{ url_for('main.global_analysis') }}">D√©partements</a>
        </nav>
        <div class="header-logout">
            <a href="{{ url_for('main.logout') }}">D√©connexion</a>
        </div>
    </div>
</header>
    <div class="course-slider-container">
        <h3>Choisissez un cours</h3>
        
        <ul class="course-list">
            {% for row in data %}
            <li><a href="#" class="course-link" data-cours="{{ row.cours }}" data-lien="{{ row.lien }}">{{ row.cours }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <div class="extract-container" style="margin-right:320px;">
        <h2 class="extract-title">Liste des Utilisateurs par D√©partement</h2>
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="department-filter" class="form-label">Filtrer par d√©partement:</label>
                <select id="department-filter" class="form-select">
                    <option value="">Tous les d√©partements</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}">{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="projet-filter" class="form-label">Filtrer par projet actuel:</label>
                <select id="projet-filter" class="form-select">
                    <option value="">Tous les projets</option>
                    {% for user in users_departments|unique(attribute='projet_actuel') %}
                    {% if user.projet_actuel %}
                    <option value="{{ user.projet_actuel }}">{{ user.projet_actuel }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="contrat-filter" class="form-label">Filtrer par type de contrat:</label>
                <select id="contrat-filter" class="form-select">
                    <option value="">Tous les contrats</option>
                    {% for user in users_departments|unique(attribute='type_contrat') %}
                    {% if user.type_contrat %}
                    <option value="{{ user.type_contrat }}">{{ user.type_contrat }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="rows-per-page" class="form-label">Lignes par page:</label>
                <select id="rows-per-page" class="form-select">
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <span class="me-2">Showing</span>
                <select id="start-range" class="form-select form-select-sm" style="width: auto;">
                    {% for i in range(1, total_rows + 1, 10) %}
                    <option value="{{ i }}">{{ i }}-{{ i + 9 }}</option>
                    {% endfor %}
                </select>
                <span class="ms-2">out of {{ total_rows }}</span>
            </div>
            <div class="pagination-controls">
                <button class="btn btn-sm btn-outline-secondary me-2" id="prev-page">&lt;</button>
                <button class="btn btn-sm btn-outline-secondary" id="next-page">&gt;</button>
            </div>
        </div>
        <table class="table table-bordered table-striped mt-4">
            <thead class="table-primary">
                <tr>
                    <th>Matricule</th>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>Projet Actuel</th>
                    <th>Fonction Actuelle</th>
                    <th>Type de contrat</th>
                    <th>D√©partement Actuel</th>
                </tr>
            </thead>
            <tbody>
                {% if users_departments %}
                    {% for user in users_departments %}
                    <tr>
                        <td>{{ user.matricule }}</td>
                        <td>{{ user.nom }}</td>
                        <td>{{ user.prenom }}</td>
                        <td>{{ user.projet_actuel }}</td>
                        <td>{{ user.fonction_actuelle }}</td>
                        <td>{{ user.type_contrat }}</td>
                        <td>{{ user.departement_actuel }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">Aucune donn√©e disponible</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        
        <h2 class="extract-title">Statistiques des utilisateurs par cours</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        {% if graph_html %}
            
            <div id="users-graph">{{ graph_html|safe }}</div>
        {% endif %}
        {% if graph_completion_html %}
            
            <div id="completion-graph">{{ graph_completion_html|safe }}</div>
        {% endif %}
        {% if data %}
        <table class="table table-bordered table-striped mt-4">
            <thead class="table-primary">
                <tr>
                    <th>Cours</th>
                    <th>Nombre d'utilisateurs</th>
                    <th>Compl√©t√©s</th>
                    <th>Taux de compl√©tion (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ row.cours }}</td>
                    <td>{{ row.users }}</td>
                    <td>{{ row.completed }}</td>
                    <td>{% if row.taux_completion != 'N/A' %}{{ row.taux_completion }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        <div id="course-content"></div>
        <div class="text-center mt-4">
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-primary">D√©connexion</a>
            {% if data %}
            <a href="{{ url_for('main.export_excel') }}" class="btn btn-success ml-2">Exporter en Excel</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-info ml-2">üìä Dashboard par D√©partement</a>
            <a href="{{ url_for('main.departments_dashboard') }}" class="btn btn-primary ml-2">üèõÔ∏è Vue D√©taill√©e des D√©partements</a>
            <a href="{{ url_for('main.global_analysis') }}" class="btn btn-warning ml-2">üîç Analyse Globale des Cours</a>
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="{{ url_for('static', filename='js/extract.js') }}"></script>
</body>
</html> 