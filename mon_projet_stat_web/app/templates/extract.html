<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Extraction des statistiques</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .extract-container { max-width: 1000px; margin-left: 200px; background: #fff; border-radius: 1.2rem; box-shadow: 0 4px 16px rgba(78,84,200,0.08); padding: 2rem; }
        .extract-title { text-align: center; color: #4e54c8; font-weight: 700; margin-bottom: 2rem; }
        .table { margin-top: 2rem; }
    </style>
</head>
<body class="bg-light">
    <div class="course-slider-container" style="position:fixed; right:0; top:0; width:300px; z-index:1000; background:#4e54c8; height:100vh; padding:2rem 1rem; color:#fff;">
        <h3 style="color:#fff; text-align:center;">Choisissez un cours</h3>
        <div id="course-slider" class="d-flex overflow-auto" style="gap:1rem; padding:1rem; background:#eaeaff; border-radius:1rem; overflow-x:auto; display:flex; margin-bottom:2rem;">
            {% for row in data %}
            <button class="btn btn-outline-primary course-slide-btn" data-cours="{{ row.cours }}" data-lien="{{ row.lien }}">{{ row.cours }}</button>
            {% endfor %}
        </div>
        <ul class="course-list" style="list-style:none; padding:0;">
            {% for row in data %}
            <li style="margin-bottom:1rem;"><a href="#" class="course-link" data-cours="{{ row.cours }}" data-lien="{{ row.lien }}" style="color:#fff; text-decoration:none; font-weight:500; display:block; padding:0.75rem 1rem; border-radius:0.5rem; background:rgba(255,255,255,0.08); transition:background 0.2s;">{{ row.cours }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <div class="extract-container" style="margin-right:320px;">
        <h2 class="extract-title">Liste des Utilisateurs par D√©partement</h2>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="department-filter" class="form-label">Filtrer par d√©partement:</label>
                <select id="department-filter" class="form-select">
                    <option value="">Tous les d√©partements</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}">{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="rows-per-page" class="form-label">Lignes par page:</label>
                <select id="rows-per-page" class="form-select">
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <span class="me-2">Showing</span>
                <select id="start-range" class="form-select form-select-sm" style="width: auto;">
                    {% for i in range(1, total_rows + 1, 10) %}
                    <option value="{{ i }}">{{ i }}-{{ i + 9 }}</option>
                    {% endfor %}
                </select>
                <span class="ms-2">out of {{ total_rows }}</span>
            </div>
            <div class="pagination-controls">
                <button class="btn btn-sm btn-outline-secondary me-2" id="prev-page">&lt;</button>
                <button class="btn btn-sm btn-outline-secondary" id="next-page">&gt;</button>
            </div>
        </div>
        <table class="table table-bordered table-striped mt-4">
            <thead class="table-primary">
                <tr>
                    <th>Matricule</th>
                    <th>D√©partement Actuel</th>
                </tr>
            </thead>
            <tbody>
                {% if users_departments %}
                    {% for user in users_departments %}
                    <tr>
                        <td>{{ user.matricule }}</td>
                        <td>{{ user.departement_actuel }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2" class="text-center">Aucune donn√©e disponible</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        
        <h2 class="extract-title">Statistiques des utilisateurs par cours</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        {% if graph_html %}
            
            <div id="users-graph">{{ graph_html|safe }}</div>
        {% endif %}
        {% if graph_completion_html %}
            
            <div id="completion-graph">{{ graph_completion_html|safe }}</div>
        {% endif %}
        {% if data %}
        <table class="table table-bordered table-striped mt-4">
            <thead class="table-primary">
                <tr>
                    <th>Cours</th>
                    <th>Nombre d'utilisateurs</th>
                    <th>Compl√©t√©s</th>
                    <th>Taux de compl√©tion (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ row.cours }}</td>
                    <td>{{ row.users }}</td>
                    <td>{{ row.completed }}</td>
                    <td>{% if row.taux_completion != 'N/A' %}{{ row.taux_completion }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        <div id="course-content"></div>
        <div class="text-center mt-4">
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-primary">D√©connexion</a>
            {% if data %}
            <a href="{{ url_for('main.export_excel') }}" class="btn btn-success ml-2">Exporter en Excel</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-info ml-2">üìä Dashboard par D√©partement</a>
            <a href="{{ url_for('main.departments_dashboard') }}" class="btn btn-primary ml-2">üèõÔ∏è Vue D√©taill√©e des D√©partements</a>
            <a href="{{ url_for('main.global_analysis') }}" class="btn btn-warning ml-2">üîç Analyse Globale des Cours</a>
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
    // Gestion du tableau des utilisateurs par d√©partement
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const departmentFilter = document.getElementById('department-filter');
        const rowsPerPage = document.getElementById('rows-per-page');
        const startRange = document.getElementById('start-range');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        let currentPage = 1;

        function updatePagination(filteredRows) {
            const limit = parseInt(rowsPerPage.value);
            const totalPages = Math.ceil(filteredRows.length / limit);
            
            // Mettre √† jour le s√©lecteur de plage
            startRange.innerHTML = '';
            for (let i = 0; i < filteredRows.length; i += limit) {
                const end = Math.min(i + limit, filteredRows.length);
                const option = document.createElement('option');
                option.value = i + 1;
                option.textContent = `${i + 1}-${end}`;
                option.selected = currentPage === Math.floor(i / limit) + 1;
                startRange.appendChild(option);
            }

            // Activer/d√©sactiver les boutons de pagination
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function filterTable() {
            const selectedDepartment = departmentFilter.value.toLowerCase();
            const limit = parseInt(rowsPerPage.value);
            const start = (currentPage - 1) * limit;
            
            // Filtrer d'abord par d√©partement
            const filteredRows = rows.filter(row => {
                const department = row.cells[1].textContent.toLowerCase();
                return !selectedDepartment || department === selectedDepartment;
            });

            // Appliquer la pagination
            rows.forEach(row => row.style.display = 'none');
            filteredRows.slice(start, start + limit).forEach(row => row.style.display = '');

            // Mettre √† jour la pagination
            updatePagination(filteredRows);
        }

        departmentFilter.addEventListener('change', function() {
            currentPage = 1;
            filterTable();
        });

        rowsPerPage.addEventListener('change', function() {
            currentPage = 1;
            filterTable();
        });

        startRange.addEventListener('change', function() {
            currentPage = Math.floor((parseInt(this.value) - 1) / parseInt(rowsPerPage.value)) + 1;
            filterTable();
        });

        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                filterTable();
            }
        });

        nextPageBtn.addEventListener('click', function() {
            const filteredRows = rows.filter(row => {
                const department = row.cells[1].textContent.toLowerCase();
                return !departmentFilter.value || department === departmentFilter.value.toLowerCase();
            });
            const totalPages = Math.ceil(filteredRows.length / parseInt(rowsPerPage.value));
            
            if (currentPage < totalPages) {
                currentPage++;
                filterTable();
            }
        });

        // Initial filter application
        filterTable();
    });

    // R√©cup√©rer les donn√©es du tableau pour filtrage
    const coursData = {{ cours_data_json|safe }};

    // Fonction de filtrage pour le graphique des utilisateurs
    function filterUsersData(type) {
        if (type === 'completed') {
            return coursData.filter(row => row.taux_completion === 100);
        } else if (type === 'not_completed') {
            return coursData.filter(row => row.taux_completion !== null && row.taux_completion < 100);
        } else {
            return coursData;
        }
    }

    // Fonction de filtrage pour le graphique du taux de compl√©tion
    function filterCompletionData(type) {
        if (type === 'completed') {
            // Afficher taux_completion normal
            return coursData.map(row => ({cours: row.cours, taux: row.taux_completion}));
        } else if (type === 'not_completed') {
            // Afficher 100 - taux_completion
            return coursData.map(row => ({cours: row.cours, taux: (typeof row.taux_completion === 'number' ? 100 - row.taux_completion : null)}));
        } else {
            // Par d√©faut, taux_completion normal
            return coursData.map(row => ({cours: row.cours, taux: row.taux_completion}));
        }
    }

    // Mettre √† jour le graphique des utilisateurs
    document.getElementById('filter-users')?.addEventListener('change', function() {
        const type = this.value;
        const filtered = filterUsersData(type);
        const x = filtered.map(row => row.cours);
        const y = filtered.map(row => row.users);
        Plotly.restyle('users-graph', {x: [x], y: [y]});
    });

    // Mettre √† jour le graphique du taux de compl√©tion
    document.getElementById('filter-completion')?.addEventListener('change', function() {
        const type = this.value;
        const filtered = filterCompletionData(type);
        const x = filtered.map(row => row.cours);
        const y = filtered.map(row => row.taux);
        let title = "Taux de compl√©tion (%) par cours";
        if (type === 'not_completed') {
            title = "Taux de non compl√©tion (%) par cours";
        } else if (type === 'completed') {
            title = "Taux de compl√©tion (%) par cours";
        }
        Plotly.restyle('completion-graph', {x: [x], y: [y]});
        Plotly.relayout('completion-graph', {title: title, 'yaxis.title.text': title});
    });

    // Ajout de la gestion sidebar :
    function showEnrolledUsers(courseName, courseUrl) {
        document.getElementById('course-content').innerHTML = `<div class='alert alert-info'>Chargement des utilisateurs pour <strong>${courseName}</strong>...</div>`;
        fetch('/get_enrolled_users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ course_url: courseUrl })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('course-content').innerHTML = `<div class='alert alert-danger'>Erreur : ${data.error}</div>`;
            } else if (data.users && data.users.length > 0) {
                // Collecter tous les d√©partements uniques
                const departments = [...new Set(data.users.map(u => u.departement).filter(Boolean))].sort();
                
                let html = `<div class='alert alert-success'>Utilisateurs inscrits pour <strong>${courseName}</strong> :</div>`;
                
                // Ajouter le filtre de d√©partement
                html += `
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="course-dept-filter" class="form-label">Filtrer par d√©partement:</label>
                            <select id="course-dept-filter" class="form-select">
                                <option value="">Tous les d√©partements</option>
                                ${departments.map(dept => `<option value="${dept}">${dept}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="course-rows-per-page" class="form-label">Lignes par page:</label>
                            <select id="course-rows-per-page" class="form-select">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>`;

                html += `<table class='table table-bordered'>
                    <thead>
                        <tr>
                            <th>N¬∞</th>
                            <th>Nom</th>
                            <th>Matricule</th>
                            <th>D√©partement</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                const usersArray = Array.from(data.users);
                window.currentCourseUsers = usersArray; // Stocker les utilisateurs pour le filtrage

                for (let i = 0; i < usersArray.length; i++) {
                    const u = usersArray[i];
                    const statusClass = {
                        'Not started': 'text-secondary',
                        'In progress': 'text-primary',
                        'Completed': 'text-success',
                        'Failed': 'text-danger',
                        'Cancelled': 'text-warning',
                        'Expired': 'text-muted',
                        'Pending': 'text-info'
                    };
                    html += `<tr>
                        <td>${i + 1}</td>
                        <td>${u.full_name || ''}</td>
                        <td>${u.matricule || ''}</td>
                        <td>${u.departement || ''}</td>
                        <td class="${statusClass[u.status] || ''}">${u.status || 'Unknown'}</td>
                    </tr>`;
                }
                html += `</tbody></table>`;
                
                // Ajouter la pagination
                html += `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span>Affichage de </span>
                        <select id="course-page-select" class="form-select d-inline-block mx-2" style="width: auto">
                            <option value="1">1-10</option>
                        </select>
                        <span>sur ${usersArray.length} entr√©es</span>
                    </div>
                    <div>
                        <button id="course-prev-page" class="btn btn-sm btn-outline-secondary">&lt;</button>
                        <button id="course-next-page" class="btn btn-sm btn-outline-secondary ms-2">&gt;</button>
                    </div>
                </div>`;
                document.getElementById('course-content').innerHTML = html;
            } else {
                document.getElementById('course-content').innerHTML = `<div class='alert alert-warning'>Aucun utilisateur inscrit trouv√© pour ce cours.</div>`;
            }
        })
        .catch(err => {
            document.getElementById('course-content').innerHTML = `<div class='alert alert-danger'>Erreur lors de la r√©cup√©ration des utilisateurs.</div>`;
        });
    }
    // Fonction pour filtrer et paginer les utilisateurs du cours
    function filterAndPaginateCourseUsers() {
        const courseContent = document.getElementById('course-content');
        const table = courseContent.querySelector('table');
        if (!table || !window.currentCourseUsers) return;

        const tbody = table.querySelector('tbody');
        const deptFilter = document.getElementById('course-dept-filter');
        const rowsPerPage = document.getElementById('course-rows-per-page');
        const pageSelect = document.getElementById('course-page-select');
        const prevBtn = document.getElementById('course-prev-page');
        const nextBtn = document.getElementById('course-next-page');

        const selectedDept = deptFilter.value;
        const limit = parseInt(rowsPerPage.value);
        const currentPage = parseInt(pageSelect.value);

        // Filtrer les utilisateurs
        const filteredUsers = window.currentCourseUsers.filter(user => 
            !selectedDept || user.departement === selectedDept
        );

        // Calculer la pagination
        const totalPages = Math.ceil(filteredUsers.length / limit);
        const start = (currentPage - 1) * limit;
        const end = Math.min(start + limit, filteredUsers.length);

        // Mettre √† jour le s√©lecteur de page
        pageSelect.innerHTML = '';
        for (let i = 0; i < filteredUsers.length; i += limit) {
            const pageEnd = Math.min(i + limit, filteredUsers.length);
            const option = document.createElement('option');
            option.value = Math.floor(i / limit) + 1;
            option.textContent = `${i + 1}-${pageEnd}`;
            option.selected = (i === start);
            pageSelect.appendChild(option);
        }

        // Activer/d√©sactiver les boutons de pagination
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages;

        // Mettre √† jour le tableau
        tbody.innerHTML = '';
        filteredUsers.slice(start, end).forEach((u, i) => {
            const row = document.createElement('tr');
            const statusClass = {
                'Not started': 'text-secondary',
                'In progress': 'text-primary',
                'Completed': 'text-success',
                'Failed': 'text-danger',
                'Cancelled': 'text-warning',
                'Expired': 'text-muted',
                'Pending': 'text-info'
            };
            row.innerHTML = `
                <td>${start + i + 1}</td>
                <td>${u.full_name || ''}</td>
                <td>${u.matricule || ''}</td>
                <td>${u.departement || ''}</td>
                <td class="${statusClass[u.status] || ''}">${u.status || 'Unknown'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Gestionnaire d'√©v√©nements pour le filtre et la pagination du cours
    document.addEventListener('click', function(e) {
        if (e.target.matches('#course-prev-page')) {
            const pageSelect = document.getElementById('course-page-select');
            if (pageSelect && pageSelect.selectedIndex > 0) {
                pageSelect.selectedIndex--;
                filterAndPaginateCourseUsers();
            }
        } else if (e.target.matches('#course-next-page')) {
            const pageSelect = document.getElementById('course-page-select');
            if (pageSelect && pageSelect.selectedIndex < pageSelect.options.length - 1) {
                pageSelect.selectedIndex++;
                filterAndPaginateCourseUsers();
            }
        }
    });

    document.addEventListener('change', function(e) {
        if (e.target.matches('#course-dept-filter, #course-rows-per-page, #course-page-select')) {
            filterAndPaginateCourseUsers();
        }
    });

    document.querySelectorAll('.course-link, .course-slide-btn').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            const cours = this.getAttribute('data-cours');
            const lien = this.getAttribute('data-lien');
            if (lien) {
                showEnrolledUsers(cours, lien);
            } else {
                document.getElementById('course-content').innerHTML = `<div class='alert alert-warning'>Aucun lien de cours trouv√©.</div>`;
            }
        });
    });
    </script>
</body>
</html> 